{% extends "base.html" %}

{% block title %}Secret Key - Social Media{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('profile') }}">
            <i class="fas fa-users me-2"></i>Social Media
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="{{ url_for('profile') }}">
                    <i class="fas fa-home me-1"></i>Profile
                </a>
                <a class="nav-link" href="#" onclick="alert('Posts coming soon!')">
                    <i class="fas fa-newspaper me-1"></i>Posts
                </a>
            </div>

            <!-- Search Bar -->
            <div class="search-bar position-relative me-3">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="form-control" placeholder="Search users..." onclick="alert('Search coming soon!')">
            </div>

            <div class="navbar-nav">
                <!-- Messages Icon -->
                <a class="nav-link" href="#" onclick="alert('Messages coming soon!')">
                    <i class="fas fa-envelope"></i>
                </a>

                <!-- Friends Icon -->
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="friendsDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-friends"></i>
                        <span class="badge bg-primary rounded-pill ms-1 d-none">0</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><h6 class="dropdown-header">Friends</h6></li>
                        <li><a class="dropdown-item" href="#">No friends yet</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('friends_list') }}">
                            Friend Requests <span class="badge bg-warning text-dark">0</span>
                        </a></li>
                    </ul>
                </div>

                <!-- Profile Dropdown -->
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        {{ current_user.username }}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('profile') }}">
                            <i class="fas fa-user me-2"></i>My Profile
                        </a></li>
                        <li><a class="dropdown-item active" href="{{ url_for('show_secret_key') }}">
                            <i class="fas fa-key me-2"></i>Secret Key
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('activity_log') }}">
                            <i class="fas fa-history me-2"></i>Activity Log
                        </a></li>
                        {% if current_user.is_admin %}
                        <li><a class="dropdown-item" href="{{ url_for('admin_panel') if current_user.is_admin else '#' }}" onclick="if(!{{ current_user.is_admin|lower }}){ alert('Admin panel coming soon!') }">
                            <i class="fas fa-cog me-2"></i>Admin Panel
                        </a></li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-lg">
                <div class="card-header bg-warning text-white">
                    <h4 class="mb-0"><i class="fas fa-key me-2"></i>Your Secret Key</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning!</strong> This key is unique to your profile. Keep it secure and do not share it with anyone.
                        If someone gains access to this key, they may be able to access your profile information.
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Your Secret Key:</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="secretKey" value="{{ secret_key }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copyButton">
                                <i class="fas fa-copy me-1"></i>Copy
                            </button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('profile') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Profile
                        </a>
                        <button class="btn btn-primary" id="regenerateButton">
                            <i class="fas fa-sync-alt me-1"></i>Regenerate Key
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Regeneration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to regenerate your secret key?</p>
                <p class="text-muted">This action cannot be undone. Your old secret key will no longer be valid.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRegenerate">Regenerate</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Copy to clipboard functionality
document.getElementById('copyButton').addEventListener('click', function() {
    const secretKeyInput = document.getElementById('secretKey');
    secretKeyInput.select();
    document.execCommand('copy');

    const originalHTML = this.innerHTML;
    this.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
    this.classList.remove('btn-outline-secondary');
    this.classList.add('btn-success');

    setTimeout(() => {
        this.innerHTML = originalHTML;
        this.classList.remove('btn-success');
        this.classList.add('btn-outline-secondary');
    }, 2000);
});

// Regenerate key functionality
document.getElementById('regenerateButton').addEventListener('click', function() {
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    confirmModal.show();
});

document.getElementById('confirmRegenerate').addEventListener('click', function() {
    fetch('{{ url_for("regenerate_secret_key") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('secretKey').value = data.new_key;
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            modal.hide();

            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Secret key regenerated successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alert, document.querySelector('.card-body').firstChild);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error regenerating secret key');
    });
});
</script>
{% endblock %}