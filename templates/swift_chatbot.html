<!-- Swift Chatbot Widget -->
<div id="swift-chatbot" class="swift-chatbot">
    <!-- Minimized State -->
    <div id="chat-minimized" class="chat-minimized" onclick="toggleChat()">
        <div class="chat-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="chat-info">
            <span class="chat-name">Swift</span>
            <span class="chat-status">AI Assistant</span>
        </div>
        <div class="chat-actions">
            <button class="minimize-btn" id="minimize-btn">
                <i class="fas fa-minus"></i>
            </button>
        </div>
    </div>

    <!-- Expanded Chat Window -->
    <div id="chat-expanded" class="chat-expanded" style="display: none;">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="header-left">
                <div class="chat-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chat-info">
                    <span class="chat-name">Swift</span>
                    <span class="chat-status">Online</span>
                </div>
            </div>
            <div class="header-right">
                <div class="dropdown">
                    <button class="btn btn-link text-white" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="startNewChat()">
                            <i class="fas fa-plus me-2"></i>New Chat
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="showChatHistory()">
                            <i class="fas fa-history me-2"></i>Chat History
                        </a></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteCurrentChat()">
                            <i class="fas fa-trash me-2"></i>Delete Current Chat
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteAllChats()">
                            <i class="fas fa-trash me-2"></i>Delete All Chats
                        </a></li>
                    </ul>
                </div>
                <button class="minimize-btn" onclick="toggleChat()">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="chat-messages">
            <div class="welcome-message">
                <div class="assistant-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm Swift, your AI assistant. How can I help you today?</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="typing-indicator" style="display: none;">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input">
            <div class="input-container">
                <textarea id="message-input"
                          placeholder="Type your message..."
                          rows="1"
                          onkeypress="handleKeyPress(event)"></textarea>
                <button id="send-btn" onclick="sendMessage()" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.swift-chatbot {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

/* Minimized State */
.chat-minimized {
    background: linear-gradient(135deg, #0084ff, #0056b3);
    color: white;
    border-radius: 25px;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 132, 255, 0.3);
    transition: all 0.3s ease;
    min-width: 250px;
}

.chat-minimized:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 132, 255, 0.4);
}

.chat-avatar {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.chat-info {
    flex-grow: 1;
}

.chat-name {
    font-weight: 600;
    font-size: 14px;
    display: block;
}

.chat-status {
    font-size: 12px;
    opacity: 0.9;
}

.minimize-btn {
    background: none;
    border: none;
    color: white;
    padding: 5px;
    cursor: pointer;
    border-radius: 50%;
    transition: background 0.3s;
}

.minimize-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Expanded Chat Window */
.chat-expanded {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 375px;
    height: 600px;
    background: white;
    border-radius: 10px 10px 0 0;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Chat Header */
.chat-header {
    background: linear-gradient(135deg, #0084ff, #0056b3);
    color: white;
    padding: 15px;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 10px;
}

.header-right .minimize-btn {
    background: rgba(255, 255, 255, 0.1);
}

/* Chat Messages */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f0f2f5;
}

.welcome-message .assistant-message {
    margin-bottom: 15px;
}

.assistant-message, .user-message {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.assistant-message {
    justify-content: flex-start;
}

.user-message {
    justify-content: flex-end;
}

.message-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #0084ff, #0056b3);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.message-content {
    max-width: 70%;
    background: white;
    padding: 10px 15px;
    border-radius: 18px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.user-message .message-content {
    background: linear-gradient(135deg, #0084ff, #0056b3);
    color: white;
}

.message-content p {
    margin: 0;
    word-wrap: break-word;
}

/* Typing Indicator */
.typing-indicator {
    display: flex;
    gap: 10px;
    padding: 0 20px;
    margin-bottom: 15px;
}

.typing-dots {
    background: white;
    padding: 10px 15px;
    border-radius: 18px;
    display: flex;
    gap: 4px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.typing-dots span {
    width: 8px;
    height: 8px;
    background: #8e9297;
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

/* Chat Input */
.chat-input {
    padding: 15px;
    background: white;
    border-top: 1px solid #e4e6eb;
}

.input-container {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

#message-input {
    flex: 1;
    border: 1px solid #e4e6eb;
    border-radius: 20px;
    padding: 10px 15px;
    resize: none;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
    max-height: 120px;
    min-height: 40px;
}

#message-input:focus {
    outline: none;
    border-color: #0084ff;
}

#send-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: #e4e6eb;
    color: #8e9297;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

#send-btn:not(:disabled):hover {
    background: #0084ff;
    color: white;
}

#send-btn:disabled {
    cursor: not-allowed;
}

#send-btn.active {
    background: #0084ff;
    color: white;
}

/* Chat History Modal */
#chat-history-modal .modal-content {
    max-height: 400px;
}

.chat-history-item {
    padding: 10px 15px;
    border-bottom: 1px solid #e4e6eb;
    transition: background 0.3s;
}

.chat-history-item:hover {
    background: #f0f2f5;
}

.chat-history-item div[onclick]:hover {
    background: #f0f2f5;
    margin: -10px -15px;
    padding: 10px 15px;
    border-radius: 5px;
}

.chat-history-preview {
    font-size: 12px;
    color: #8e9297;
    margin-top: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Responsive Design */
@media (max-width: 480px) {
    .swift-chatbot {
        bottom: 10px;
        right: 10px;
        left: 10px;
    }

    .chat-expanded {
        width: 100%;
        height: calc(100vh - 60px);
    }

    .message-content {
        max-width: 85%;
    }
}
</style>

<script>
// Chat state
let currentSessionId = null;
let isExpanded = false;

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    // Load or generate session ID
    currentSessionId = localStorage.getItem('swift_session_id') ||
                      'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('swift_session_id', currentSessionId);

    // Load chat history if exists
    loadChatHistory();
});

// Toggle chat window
function toggleChat() {
    const minimized = document.getElementById('chat-minimized');
    const expanded = document.getElementById('chat-expanded');

    isExpanded = !isExpanded;

    if (isExpanded) {
        minimized.style.display = 'none';
        expanded.style.display = 'flex';
        document.getElementById('message-input').focus();
    } else {
        minimized.style.display = 'flex';
        expanded.style.display = 'none';
    }
}

// Handle enter key in input
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }

    // Auto-resize textarea
    event.target.style.height = 'auto';
    event.target.style.height = Math.min(event.target.scrollHeight, 120) + 'px';
}

// Enable/disable send button
document.getElementById('message-input').addEventListener('input', function() {
    const sendBtn = document.getElementById('send-btn');
    if (this.value.trim()) {
        sendBtn.disabled = false;
        sendBtn.classList.add('active');
    } else {
        sendBtn.disabled = true;
        sendBtn.classList.remove('active');
    }
});

// Send message
async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();

    if (!message) return;

    // Add user message to chat
    addMessage(message, 'user');

    // Clear input
    input.value = '';
    input.style.height = 'auto';
    document.getElementById('send-btn').disabled = true;
    document.getElementById('send-btn').classList.remove('active');

    // Show typing indicator
    showTypingIndicator();

    try {
        // Send message to server
        const response = await fetch('/api/swift/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId
            })
        });

        const data = await response.json();

        // Hide typing indicator
        hideTypingIndicator();

        if (data.success) {
            // Add AI response to chat
            addMessage(data.response, 'assistant');
        } else {
            addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
        }
    } catch (error) {
        hideTypingIndicator();
        addMessage('Sorry, I\'m having trouble connecting. Please try again.', 'assistant');
        console.error('Error sending message:', error);
    }
}

// Add message to chat
function addMessage(text, sender) {
    const messagesContainer = document.getElementById('chat-messages');

    // Remove welcome message if it exists
    const welcomeMsg = messagesContainer.querySelector('.welcome-message');
    if (welcomeMsg) {
        welcomeMsg.remove();
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = sender + '-message';

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';
    avatarDiv.innerHTML = sender === 'user' ?
        `<i class="fas fa-user"></i>` :
        `<i class="fas fa-robot"></i>`;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    const paragraph = document.createElement('p');
    paragraph.textContent = text;

    contentDiv.appendChild(paragraph);
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);

    messagesContainer.appendChild(messageDiv);

    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Show/hide typing indicator
function showTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'flex';
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'none';
}

// Start new chat
function startNewChat() {
    if (confirm('Start a new chat? Current chat will be saved to history.')) {
        // Save current session
        currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('swift_session_id', currentSessionId);

        // Clear chat messages
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = `
            <div class="welcome-message">
                <div class="assistant-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm Swift, your AI assistant. How can I help you today?</p>
                    </div>
                </div>
            </div>
        `;
    }
}

// Show chat history
async function showChatHistory() {
    try {
        const response = await fetch('/api/swift/chat/history');
        const data = await response.json();

        if (data.success && data.sessions.length > 0) {
            // Create modal to show history
            const modalHtml = `
                <div class="modal fade" id="chat-history-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chat History</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                                ${data.sessions.map(session => `
                                    <div class="chat-history-item d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1" onclick="loadSession('${session.session_id}')" style="cursor: pointer;">
                                            <div class="fw-bold">${new Date(session.created_at).toLocaleString()}</div>
                                            <div class="chat-history-preview">${session.last_message}</div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSession('${session.session_id}')" title="Delete this chat">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to DOM
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('chat-history-modal'));
            modal.show();

            // Remove modal from DOM when hidden
            document.getElementById('chat-history-modal').addEventListener('hidden.bs.modal', function() {
                modalContainer.remove();
            });
        } else {
            alert('No chat history found.');
        }
    } catch (error) {
        console.error('Error loading chat history:', error);
        alert('Error loading chat history.');
    }
}

// Load specific session
async function loadSession(sessionId) {
    try {
        const response = await fetch(`/api/swift/chat/session/${sessionId}`);
        const data = await response.json();

        if (data.success) {
            currentSessionId = sessionId;
            localStorage.setItem('swift_session_id', sessionId);

            // Clear and reload messages
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';

            // Load messages
            data.messages.forEach(msg => {
                addMessage(msg.user_message, 'user');
                addMessage(msg.ai_response, 'assistant');
            });

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('chat-history-modal')).hide();
        }
    } catch (error) {
        console.error('Error loading session:', error);
        alert('Error loading chat session.');
    }
}

// Delete specific session
async function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this chat session?')) {
        try {
            const response = await fetch(`/api/swift/chat/session/${sessionId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                // If deleting current session, start a new one
                if (sessionId === currentSessionId) {
                    startNewChat();
                }

                alert('Chat session deleted successfully.');

                // Reload and show history again to update the list
                showChatHistory();
            } else {
                alert('Error deleting chat session.');
            }
        } catch (error) {
            console.error('Error deleting session:', error);
            alert('Error deleting chat session.');
        }
    }
}

// Delete current chat session
async function deleteCurrentChat() {
    if (confirm('Are you sure you want to delete the current chat session?')) {
        try {
            const response = await fetch(`/api/swift/chat/session/${currentSessionId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                alert('Current chat deleted successfully.');
                // Start a new chat
                startNewChat();
            } else {
                alert('Error deleting current chat.');
            }
        } catch (error) {
            console.error('Error deleting current chat:', error);
            alert('Error deleting current chat.');
        }
    }
}

// Delete all chats
async function deleteAllChats() {
    if (confirm('Are you sure you want to delete all chat history? This cannot be undone.')) {
        try {
            const response = await fetch('/api/swift/chat/history', {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                // Start new chat
                startNewChat();
                alert('All chat history deleted successfully.');
            } else {
                alert('Error deleting chat history.');
            }
        } catch (error) {
            console.error('Error deleting chat history:', error);
            alert('Error deleting chat history.');
        }
    }
}

// Load current chat history
async function loadChatHistory() {
    try {
        const response = await fetch(`/api/swift/chat/session/${currentSessionId}`);
        const data = await response.json();

        if (data.success && data.messages.length > 0) {
            // Clear welcome message
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';

            // Load messages
            data.messages.forEach(msg => {
                addMessage(msg.user_message, 'user');
                addMessage(msg.ai_response, 'assistant');
            });
        }
    } catch (error) {
        console.error('Error loading chat history:', error);
    }
}
</script>